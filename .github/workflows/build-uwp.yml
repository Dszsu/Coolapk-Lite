name: Build Coolapk-Lite UWP

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  build:
    runs-on: windows-2022

    env:
      CONFIGURATION: Release
      PLATFORM: x64
      UWP_SDK_VERSION: 10.0.19041.0

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Setup tools
      # -----------------------------
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      # -----------------------------
      # Locate solution (ABSOLUTE PATH)
      # -----------------------------
      - name: Find solution file
        id: find_sln
        shell: pwsh
        run: |
          $sln = Get-ChildItem -Recurse -Filter *.sln | Select-Object -First 1
          if (-not $sln) {
            Write-Error "No .sln file found"
            exit 1
          }
          Write-Host "Found solution: $($sln.FullName)"
          "SLN_PATH=$($sln.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

      # -----------------------------
      # Cache NuGet
      # -----------------------------
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/*.sln') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      # -----------------------------
      # Force UWP SDK = 19041
      # -----------------------------
      - name: Fix UWP TargetPlatformVersion
        shell: pwsh
        run: |
          $pattern = '10\.0\.\d{5}\.0'
          Get-ChildItem -Recurse -Include *.csproj,*.props,*.targets | ForEach-Object {
            $content = Get-Content $_.FullName -Raw
            if ($content -match $pattern) {
              Write-Host "Fixing $($_.FullName)"
              $content = [regex]::Replace($content, $pattern, $env:UWP_SDK_VERSION)
              Set-Content $_.FullName $content -Encoding UTF8
            }
          }

      # -----------------------------
      # Restore
      # -----------------------------
      - name: Restore NuGet packages
        run: |
          nuget restore "$env:SLN_PATH"

      # -----------------------------
      # Build
      # -----------------------------
      - name: Build UWP solution
        run: |
          msbuild "$env:SLN_PATH" `
            /p:Configuration=$env:CONFIGURATION `
            /p:Platform=$env:PLATFORM `
            /p:TargetPlatformVersion=$env:UWP_SDK_VERSION `
            /m
