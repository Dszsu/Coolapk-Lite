name: Build Coolapk-Lite UWP

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  build:
    runs-on: windows-2022

    env:
      CONFIGURATION: Release
      PLATFORM: x64
      UWP_SDK_VERSION: 10.0.19041.0

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Setup build tools
      # -----------------------------
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      # -----------------------------
      # Debug: list solution (optional but safe)
      # -----------------------------
      - name: Locate solution file
        shell: pwsh
        run: |
          Get-ChildItem -Recurse -Filter *.sln

      # -----------------------------
      # Cache NuGet packages
      # -----------------------------
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/*.sln') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      # -----------------------------
      # Cache build outputs
      # -----------------------------
      - name: Cache build outputs
        uses: actions/cache@v4
        with:
          path: |
            **/bin
            **/obj
          key: build-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            build-${{ runner.os }}-

      # -----------------------------
      # Cache WindowsCommunityToolkit artifacts
      # -----------------------------
      - name: Cache WindowsCommunityToolkit
        uses: actions/cache@v4
        with:
          path: |
            CoolapkLite/WindowsCommunityToolkit/**/bin
            CoolapkLite/WindowsCommunityToolkit/**/obj
          key: toolkit-${{ runner.os }}-${{ hashFiles('CoolapkLite/WindowsCommunityToolkit/**/*.csproj') }}
          restore-keys: |
            toolkit-${{ runner.os }}-

      # -----------------------------
      # Force UWP SDK version to 19041
      # -----------------------------
      - name: Fix UWP TargetPlatformVersion
        shell: pwsh
        run: |
          Write-Host "Forcing TargetPlatformVersion to $env:UWP_SDK_VERSION"

          $pattern = '10\.0\.\d{5}\.0'
          $files = Get-ChildItem -Recurse -Include *.csproj,*.props,*.targets

          foreach ($file in $files) {
            $content = Get-Content $file.FullName -Raw
            if ($content -match $pattern) {
              Write-Host "Updating $($file.FullName)"
              $content = [regex]::Replace($content, $pattern, $env:UWP_SDK_VERSION)
              Set-Content $file.FullName $content -Encoding UTF8
            }
          }

      # -----------------------------
      # Restore NuGet (CORRECT PATH)
      # -----------------------------
      - name: Restore NuGet packages
        run: nuget restore CoolapkLite/CoolapkLite/CoolapkLite.sln

      # -----------------------------
      # Build solution (CORRECT PATH)
      # -----------------------------
      - name: Build UWP solution
        run: |
          msbuild CoolapkLite/CoolapkLite/CoolapkLite.sln `
            /p:Configuration=$env:CONFIGURATION `
            /p:Platform=$env:PLATFORM `
            /p:TargetPlatformVersion=$env:UWP_SDK_VERSION `
            /m
